trigger: none

variables:
  - group: geoNetworkAppVariables-test
  - name: imageRepository
    value: 'test'
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/app/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'

pool:
  name: DEFRA-COMMON-ubuntu2204-SSV3

steps:

- task: AzureCLI@2
  inputs:
    displayName: DockerBuildAndPush
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az account set --subscription $(subscription)
      PASSWORD=$(az acr login --name $(containerRegistry) --expose-token --output tsv --query accessToken)
      docker login $(containerRegistry) -u $(acrUser) -p $PASSWORD
      docker build -t '$(containerRegistry)/test:$(tag)' -f $(dockerfilePath) .
      docker push '$(containerRegistry)/test:$(tag)'

- task: AzureCLI@2
  inputs:
    displayName: queryAks
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az aks get-credentials --resource-group $(storageAccountResourceGroup)  --name $(aksInstanceName)
      kubectl get nodes



